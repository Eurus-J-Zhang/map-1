{% extends 'base.html' %}

{% block script %}

<script>
    var currentStation = "{{ station }}";


    // Function to show the modal with a message
    function showModal(message) {
        var myModal = document.getElementById('myModal');
        var modalText = document.getElementById('modalText');
        if (myModal && modalText) {
            modalText.innerHTML = message; // Update the modal text
            myModal.style.display = "block";
        }
    }

    // Function to close the modal and start the timer
    function closeModal() {
        var myModal = document.getElementById('myModal');
        if (myModal) {
            myModal.style.display = "none";
            startCountdown(); // Start the timer after closing the modal
        }
    }

    // Initialize the countdown timer to 120 seconds
    let countdown = 90;

    // Function to start the countdown timer
    function startCountdown() {
        const timerElement = document.getElementById('timer');

        const countdownInterval = setInterval(function() {
            // Update the timer display
            timerElement.textContent = countdown;

            // Decrease the countdown by one second
            countdown--;

            // If the countdown reaches zero, redirect to the fail page
            if (countdown < 0) {
                clearInterval(countdownInterval);
                window.location.href = "/wrong"; // Redirect to the fail page
            }
        }, 1000); // Update every second
    }

    // Set up close functionality
    document.addEventListener('DOMContentLoaded', function() {
        // startCountdown();
        var closeButton = document.getElementsByClassName("close")[0];
        var myModal = document.getElementById('myModal');

        if(closeButton && myModal) {
            // Close modal when the close button is clicked
            closeButton.onclick = function() {
                closeModal();
            };

            // Close modal when clicking outside of the modal content
            window.onclick = function(event) {
                if (event.target == myModal) {
                    closeModal();
                }
            };
        }

        // Show the modal if the station is 'Millstone Square'
        if (currentStation === 'Millstone Square') {
            showModal(`However, the metro stops at Millstone Square unexpectly, and could not continue to the 
            direction of Perivale. <br>
            It is due to ongoing construction at Bagton Mere, with no metros able to pass through.  <br>
            Please design your trip accordingly.

            `);
        }

        // let currentScore = parseInt("{{ score }}", 10); 

        // Check the score and show the modal if score <= 0
        // if (currentScore <= 0) {
        //     // showFailModal('messages');
        //     showModal('Sorry, you have run out of time. You will be directed to the result page in 3 seconds.');
        //     setTimeout(function() {
        //         window.location.href = "/wrong"; // Redirect to the wrong.html page
        //     }, 3000); // 3000 milliseconds = 3 seconds
        // }
        if (currentStation === 'Conby Vale' && currentScore > 0) {
        
            showModal('You have reached your destination! Now you can get out of the metro and finish the task.')}

        let currentTimeStr = "{{ current_time }}"; // Time passed from Flask, e.g., "08:32"

        // Check if the current time is equal to or later than 09:00
        if (currentTimeStr >= "09:00") {
            showModal('Sorry, it is already 9:00 and you have not reached your destination. You will be directed to the result page in 3 seconds.');
            setTimeout(function() {
                window.location.href = "/wrong"; // Redirect to the wrong.html page
            }, 3000); // 3000 milliseconds = 3 seconds
}

    });
</script>

{% endblock %}



{% block headline %}

<p class="t_title">


</p>

{% endblock %}

{% block top_block %}
Current station: {{ station | upper }}
<br>
Clock Time:{{current_time}} 
<br>
<!-- Time left: {{ score }} -->
<br>
Time left to make an action: <span id="timer">90</span> seconds
{% endblock %}
<br><br>

{% block left_block %}
<img src="{{ url_for('static', filename='img/map.jpg') }}" alt="Example Image" style="width: 100%;">

{% endblock %}

{% block right_block %}
<form method="POST">
    {{ form.hidden_tag() }}
    <input type="hidden" name="score" value="{{ score }}">
    
    <p>Choose your action:</p>
    {% for subfield, choice in zip(form.action, choices) %}
        <div class="radio">
            {{ subfield(disabled=not choice[2], id=subfield.id, class_="colored-radio " + choice[0]) }}
            <label for="{{ subfield.id }}" class="colored-label {{ choice[0] }}">
                {{ choice[1] | safe }}
            </label>
        </div>
    {% endfor %}

    <br>
    <p>{{ form.submit(class='continue-btn') }}</p>
</form>
{% endblock %}
